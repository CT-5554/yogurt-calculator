<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†·èƒé…¸å¥¶è¥å…»è®¡ç®—å™¨ v2.1</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
          padding: 30px;
          text-align: center;
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }

      .header p {
          font-size: 1.1em;
          opacity: 0.9;
      }

      .main-content {
          display: grid;
          grid-template-columns: 1fr 1.5fr;
          gap: 30px;
          padding: 30px;
      }

      .input-panel {
          background: #f8f9fa;
          padding: 25px;
          border-radius: 10px;
          border: 1px solid #e9ecef;
      }

      .result-panel {
          background: #fff;
          padding: 25px;
          border-radius: 10px;
          border: 1px solid #e9ecef;
      }

      .section {
          margin-bottom: 25px;
      }

      .section h3 {
          color: #333;
          margin-bottom: 15px;
          padding-bottom: 8px;
          border-bottom: 2px solid #4CAF50;
          font-size: 1.2em;
      }

      .input-group {
          margin-bottom: 15px;
      }

      .input-group label {
          display: block;
          margin-bottom: 5px;
          font-weight: 600;
          color: #555;
      }

      .input-group input, .input-group select {
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s ease;
      }

      .input-group input:focus, .input-group select:focus {
          outline: none;
          border-color: #4CAF50;
          box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      .input-group input::placeholder {
          color: #999;
      }

      .calculated-info {
          background: #e8f5e8;
          border: 2px solid #4CAF50;
          border-radius: 8px;
          padding: 15px;
          margin-top: 10px;
      }

      .calculated-info h4 {
          color: #2e7d32;
          margin-bottom: 8px;
          font-size: 1.1em;
      }

      .calculated-info .nutrient-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 5px 0;
          border-bottom: 1px solid #c8e6c9;
      }

      .calculated-info .nutrient-item:last-child {
          border-bottom: none;
      }

      .calculated-info .nutrient-label {
          font-weight: 500;
          color: #2e7d32;
      }

      .calculated-info .nutrient-value {
          font-weight: 600;
          color: #1b5e20;
          font-size: 1.1em;
      }

      .button-group {
          display: flex;
          gap: 10px;
          margin-top: 20px;
      }

      .btn {
          flex: 1;
          padding: 12px 20px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }

      .btn-primary {
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
          transform: translateY(-2px);
      }

      .btn-export {
          background: #17a2b8;
          color: white;
      }

      .btn-export:hover {
          background: #138496;
          transform: translateY(-2px);
      }

      .result-display {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          padding: 20px;
          min-height: 400px;
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          white-space: pre-wrap;
          overflow-y: auto;
      }

      .placeholder-text {
          color: #6c757d;
          font-style: italic;
          text-align: center;
          padding-top: 50px;
      }

      .error {
          background: #f8d7da;
          color: #721c24;
          padding: 10px;
          border-radius: 5px;
          margin: 10px 0;
          border: 1px solid #f5c6cb;
      }

      .success {
          background: #d4edda;
          color: #155724;
          padding: 10px;
          border-radius: 5px;
          margin: 10px 0;
          border: 1px solid #c3e6cb;
      }

      .model-info {
          background: #e3f2fd;
          padding: 15px;
          border-radius: 8px;
          margin-top: 10px;
          border-left: 4px solid #2196F3;
      }

      .model-info h4 {
          color: #1976D2;
          margin-bottom: 8px;
      }

      .model-info p {
          color: #424242;
          font-size: 0.9em;
          line-height: 1.4;
      }

      .weight-input-group {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
      }

      .serving-info {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          border-radius: 8px;
          padding: 12px;
          margin-top: 10px;
      }

      .serving-info .serving-label {
          font-size: 0.9em;
          color: #856404;
          font-weight: 500;
      }

      @media (max-width: 768px) {
          .main-content {
              grid-template-columns: 1fr;
              gap: 20px;
              padding: 20px;
          }
          
          .header h1 {
              font-size: 2em;
          }
          
          .button-group {
              flex-direction: column;
          }

          .weight-input-group {
              grid-template-columns: 1fr;
          }
      }

      .loading {
          display: none;
          text-align: center;
          padding: 20px;
      }

      .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #4CAF50;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 10px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ¥› å†·èƒé…¸å¥¶è¥å…»è®¡ç®—å™¨</h1>
          <p>æ ¹æ®è¥å…»æ ‡ç­¾è®¡ç®—çº±å¸ƒè¿‡æ»¤åˆ¶ä½œçš„å†·èƒé…¸å¥¶è¥å…»æˆåˆ†å’Œçƒ­é‡</p>
      </div>

      <div class="main-content">
          <!-- è¾“å…¥é¢æ¿ -->
          <div class="input-panel">
              <div class="section">
                  <h3>ğŸ¥› é…¸å¥¶é‡é‡ä¿¡æ¯</h3>
                  <div class="weight-input-group">
                      <div class="input-group">
                          <label for="servingSize">æ¯ä»½é‡é‡ (g)</label>
                          <input type="number" id="servingSize" placeholder="é€šå¸¸æ˜¯100" step="1" min="1" value="100">
                      </div>
                      <div class="input-group">
                          <label for="totalWeight">æ€»é‡é‡ (g)</label>
                          <input type="number" id="totalWeight" placeholder="ä¾‹å¦‚: 500" step="0.1" min="0">
                      </div>
                  </div>
                  <div class="serving-info">
                      <div class="serving-label">ğŸ’¡ æç¤ºï¼šæ¯ä»½é‡é‡é€šå¸¸æ ‡æ³¨åœ¨è¥å…»æ ‡ç­¾ä¸Šï¼Œä¸€èˆ¬ä¸º100g</div>
                  </div>
              </div>

              <div class="section">
                  <h3>ğŸ“Š æ¯ä»½è¥å…»ç´ å«é‡</h3>
                  <div class="input-group">
                      <label for="proteinPerServing">è›‹ç™½è´¨ (g/ä»½)</label>
                      <input type="number" id="proteinPerServing" placeholder="ä¾‹å¦‚: 3.1" step="0.1" min="0">
                  </div>
                  <div class="input-group">
                      <label for="fatPerServing">è„‚è‚ª (g/ä»½)</label>
                      <input type="number" id="fatPerServing" placeholder="ä¾‹å¦‚: 1.6" step="0.1" min="0">
                  </div>
                  <div class="input-group">
                      <label for="carbPerServing">ç¢³æ°´åŒ–åˆç‰© (g/ä»½)</label>
                      <input type="number" id="carbPerServing" placeholder="ä¾‹å¦‚: 2.5" step="0.1" min="0">
                  </div>
                  
                  <!-- è‡ªåŠ¨è®¡ç®—çš„æ€»è¥å…»ç´ æ˜¾ç¤º -->
                  <div class="calculated-info" id="totalNutrientsInfo" style="display: none;">
                      <h4>ğŸ“‹ è®¡ç®—å¾—å‡ºçš„æ€»è¥å…»ç´ å«é‡ï¼š</h4>
                      <div class="nutrient-item">
                          <span class="nutrient-label">è›‹ç™½è´¨æ€»é‡ï¼š</span>
                          <span class="nutrient-value" id="totalProtein">0.0 g</span>
                      </div>
                      <div class="nutrient-item">
                          <span class="nutrient-label">è„‚è‚ªæ€»é‡ï¼š</span>
                          <span class="nutrient-value" id="totalFat">0.0 g</span>
                      </div>
                      <div class="nutrient-item">
                          <span class="nutrient-label">ç¢³æ°´åŒ–åˆç‰©æ€»é‡ï¼š</span>
                          <span class="nutrient-value" id="totalCarb">0.0 g</span>
                      </div>
                      <div class="nutrient-item">
                          <span class="nutrient-label">æ€»ä»½æ•°ï¼š</span>
                          <span class="nutrient-value" id="totalServings">0.0 ä»½</span>
                      </div>
                  </div>
              </div>

              <div class="section">
                  <h3>ğŸ’§ è¿‡æ»¤ä¿¡æ¯</h3>
                  <div class="input-group">
                      <label for="wheyWeight">ä¹³æ¸…é‡é‡ (g)</label>
                      <input type="number" id="wheyWeight" placeholder="ä¾‹å¦‚: 150" step="0.1" min="0">
                  </div>
              </div>

              <div class="section">
                  <h3>âš™ï¸ è®¡ç®—æ¨¡å‹</h3>
                  <div class="input-group">
                      <select id="calculationModel">
                          <option value="realistic">ç°å®æ¨¡å‹ (è€ƒè™‘è¥å…»ç´ æµå¤±)</option>
                          <option value="proportional">æ¯”ä¾‹åˆ†å¸ƒæ¨¡å‹ (ç†æƒ³çŠ¶æ€)</option>
                      </select>
                  </div>
                  <div class="model-info" id="modelInfo">
                      <h4>ç°å®æ¨¡å‹</h4>
                      <p>è€ƒè™‘è¿‡æ»¤è¿‡ç¨‹ä¸­è¥å…»ç´ çš„å®é™…æµå¤±æƒ…å†µï¼Œè›‹ç™½è´¨æµå¤±5%ï¼Œè„‚è‚ªæµå¤±2%ï¼Œç¢³æ°´åŒ–åˆç‰©æµå¤±85%ã€‚è®¡ç®—ç»“æœæ›´æ¥è¿‘å®é™…æƒ…å†µã€‚</p>
                  </div>
              </div>

              <div class="button-group">
                  <button class="btn btn-primary" onclick="calculateNutrients()">ğŸ” å¼€å§‹è®¡ç®—</button>
                  <button class="btn btn-secondary" onclick="clearInputs()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å…¥</button>
                  <button class="btn btn-export" onclick="exportResults()">ğŸ’¾ å¯¼å‡ºç»“æœ</button>
              </div>
          </div>

          <!-- ç»“æœé¢æ¿ -->
          <div class="result-panel">
              <div class="section">
                  <h3>ğŸ“‹ è®¡ç®—ç»“æœ</h3>
                  <div class="loading" id="loading">
                      <div class="spinner"></div>
                      <p>æ­£åœ¨è®¡ç®—ä¸­...</p>
                  </div>
                  <div class="result-display" id="resultDisplay">
                      <div class="placeholder-text">
                          è®¡ç®—ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...<br><br>
                          è¯·åœ¨å·¦ä¾§è¾“å…¥æ•°æ®åç‚¹å‡»"å¼€å§‹è®¡ç®—"æŒ‰é’®ã€‚<br><br>
                          ğŸ’¡ ä½¿ç”¨æç¤ºï¼š<br>
                          â€¢ æ¯ä»½é‡é‡ï¼šæŸ¥çœ‹è¥å…»æ ‡ç­¾ä¸Šçš„"æ¯ä»½"æˆ–"æ¯100g"<br>
                          â€¢ è¥å…»ç´ å«é‡ï¼šç›´æ¥è¾“å…¥æ ‡ç­¾ä¸Šå¯¹åº”çš„æ•°å€¼<br>
                          â€¢ æ€»é‡é‡ï¼šä½ è´­ä¹°çš„é…¸å¥¶æ€»é‡é‡<br>
                          â€¢ ä¹³æ¸…é‡é‡ï¼šè¿‡æ»¤ååˆ†ç¦»å‡ºçš„ä¹³æ¸…é‡é‡
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
      // è¥å…»è®¡ç®—å™¨ç±»
      class YogurtCalculator {
          constructor() {
              this.proteinCaloriesPerGram = 4;
              this.fatCaloriesPerGram = 9;
              this.carbohydrateCaloriesPerGram = 4;
          }

          // è®¡ç®—æ€»è¥å…»ç´ å«é‡
          calculateTotalNutrients(servingSize, totalWeight, nutrientsPerServing) {
              const totalServings = totalWeight / servingSize;
              
              return {
                  totalServings: totalServings,
                  protein: nutrientsPerServing.protein * totalServings,
                  fat: nutrientsPerServing.fat * totalServings,
                  carbohydrate: nutrientsPerServing.carbohydrate * totalServings
              };
          }

          calculate(inputData, useRealisticModel = true) {
              // éªŒè¯è¾“å…¥æ•°æ®
              this.validateInput(inputData);

              // è®¡ç®—å†·èƒé…¸å¥¶é‡é‡
              const concentratedWeight = inputData.totalWeight - inputData.wheyWeight;
              const concentrationRatio = inputData.totalWeight / concentratedWeight;

              // è®¡ç®—è¥å…»ç´ å«é‡
              let concentratedNutrients;
              if (useRealisticModel) {
                  concentratedNutrients = this.calculateRealisticNutrients(inputData.totalNutrients, concentratedWeight);
              } else {
                  concentratedNutrients = this.calculateProportionalNutrients(inputData.totalNutrients, concentrationRatio);
              }

              // è®¡ç®—çƒ­é‡
              const totalCalories = this.calculateCalories(concentratedNutrients);
              const caloriesPer100g = (totalCalories / concentratedWeight) * 100;

              return {
                  concentratedWeight,
                  concentrationRatio,
                  concentratedNutrients,
                  totalCalories,
                  caloriesPer100g,
                  totalServings: inputData.totalNutrients.totalServings
              };
          }

          validateInput(data) {
              if (data.servingSize <= 0) {
                  throw new Error("æ¯ä»½é‡é‡å¿…é¡»å¤§äº0");
              }
              if (data.totalWeight <= 0) {
                  throw new Error("æ€»é‡é‡å¿…é¡»å¤§äº0");
              }
              if (data.wheyWeight <= 0) {
                  throw new Error("ä¹³æ¸…é‡é‡å¿…é¡»å¤§äº0");
              }
              if (data.wheyWeight >= data.totalWeight) {
                  throw new Error("ä¹³æ¸…é‡é‡ä¸èƒ½å¤§äºç­‰äºæ€»é‡é‡");
              }
              if (data.nutrientsPerServing.protein < 0 || data.nutrientsPerServing.fat < 0 || data.nutrientsPerServing.carbohydrate < 0) {
                  throw new Error("è¥å…»ç´ å«é‡ä¸èƒ½ä¸ºè´Ÿæ•°");
              }
          }

          calculateRealisticNutrients(totalNutrients, concentratedWeight) {
              // ç°å®æ¨¡å‹ï¼šè€ƒè™‘è¥å…»ç´ æµå¤±
              const proteinLossRate = 0.05; // è›‹ç™½è´¨æµå¤±5%
              const fatLossRate = 0.02;     // è„‚è‚ªæµå¤±2%
              const carbLossRate = 0.85;    // ç¢³æ°´åŒ–åˆç‰©æµå¤±15%

              const retainedProtein = totalNutrients.protein * (1 - proteinLossRate);
              const retainedFat = totalNutrients.fat * (1 - fatLossRate);
              const retainedCarb = totalNutrients.carbohydrate * (1 - carbLossRate);

              return {
                  protein: retainedProtein,
                  fat: retainedFat,
                  carbohydrate: retainedCarb
              };
          }

          calculateProportionalNutrients(totalNutrients, concentrationRatio) {
              // æ¯”ä¾‹åˆ†å¸ƒæ¨¡å‹ï¼šç†æƒ³çŠ¶æ€ï¼Œè¥å…»ç´ å®Œå…¨ä¿ç•™
              return {
                  protein: totalNutrients.protein,
                  fat: totalNutrients.fat,
                  carbohydrate: totalNutrients.carbohydrate
              };
          }

          calculateCalories(nutrients) {
              return (nutrients.protein * this.proteinCaloriesPerGram) +
                     (nutrients.fat * this.fatCaloriesPerGram) +
                     (nutrients.carbohydrate * this.carbohydrateCaloriesPerGram);
          }
      }

      // å…¨å±€å˜é‡
      const calculator = new YogurtCalculator();
      let lastResult = null;

      // å®æ—¶è®¡ç®—æ€»è¥å…»ç´ å«é‡
      function updateTotalNutrients() {
          const servingSize = parseFloat(document.getElementById('servingSize').value) || 0;
          const totalWeight = parseFloat(document.getElementById('totalWeight').value) || 0;
          const proteinPerServing = parseFloat(document.getElementById('proteinPerServing').value) || 0;
          const fatPerServing = parseFloat(document.getElementById('fatPerServing').value) || 0;
          const carbPerServing = parseFloat(document.getElementById('carbPerServing').value) || 0;

          const totalNutrientsInfo = document.getElementById('totalNutrientsInfo');
          
          if (servingSize > 0 && totalWeight > 0 && (proteinPerServing > 0 || fatPerServing > 0 || carbPerServing > 0)) {
              const totalServings = totalWeight / servingSize;
              const totalProtein = proteinPerServing * totalServings;
              const totalFat = fatPerServing * totalServings;
              const totalCarb = carbPerServing * totalServings;

              document.getElementById('totalServings').textContent = totalServings.toFixed(1) + ' ä»½';
              document.getElementById('totalProtein').textContent = totalProtein.toFixed(1) + ' g';
              document.getElementById('totalFat').textContent = totalFat.toFixed(1) + ' g';
              document.getElementById('totalCarb').textContent = totalCarb.toFixed(1) + ' g';
              
              totalNutrientsInfo.style.display = 'block';
          } else {
              totalNutrientsInfo.style.display = 'none';
          }
      }

      // ä¸ºæ‰€æœ‰ç›¸å…³è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      document.addEventListener('DOMContentLoaded', function() {
          const inputs = ['servingSize', 'totalWeight', 'proteinPerServing', 'fatPerServing', 'carbPerServing'];
          inputs.forEach(id => {
              const element = document.getElementById(id);
              element.addEventListener('input', updateTotalNutrients);
              element.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                      calculateNutrients();
                  }
              });
          });

          // ä¹³æ¸…é‡é‡è¾“å…¥æ¡†ä¹Ÿæ·»åŠ å›è½¦äº‹ä»¶
          document.getElementById('wheyWeight').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                  calculateNutrients();
              }
          });
          
          // è®¾ç½®ç„¦ç‚¹åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
          document.getElementById('totalWeight').focus();
      });

      // æ¨¡å‹é€‰æ‹©æ”¹å˜æ—¶æ›´æ–°è¯´æ˜
      document.getElementById('calculationModel').addEventListener('change', function() {
          const modelInfo = document.getElementById('modelInfo');
          const isRealistic = this.value === 'realistic';
          
          if (isRealistic) {
              modelInfo.innerHTML = `
                  <h4>ç°å®æ¨¡å‹</h4>
                  <p>è€ƒè™‘è¿‡æ»¤è¿‡ç¨‹ä¸­è¥å…»ç´ çš„å®é™…æµå¤±æƒ…å†µï¼Œè›‹ç™½è´¨æµå¤±5%ï¼Œè„‚è‚ªæµå¤±2%ï¼Œç¢³æ°´åŒ–åˆç‰©æµå¤±15%ã€‚è®¡ç®—ç»“æœæ›´æ¥è¿‘å®é™…æƒ…å†µã€‚</p>
              `;
          } else {
              modelInfo.innerHTML = `
                  <h4>æ¯”ä¾‹åˆ†å¸ƒæ¨¡å‹</h4>
                  <p>å‡è®¾è¥å…»ç´ åœ¨è¿‡æ»¤è¿‡ç¨‹ä¸­ä¸ä¼šæµå¤±ï¼Œå®Œå…¨ä¿ç•™åœ¨å†·èƒé…¸å¥¶ä¸­ã€‚è¿™æ˜¯ç†æƒ³åŒ–çš„è®¡ç®—æ¨¡å‹ï¼Œå®é™…æƒ…å†µå¯èƒ½æœ‰æ‰€ä¸åŒã€‚</p>
              `;
          }
      });

      // è¾“å…¥éªŒè¯
      function validateInputs() {
          const servingSize = parseFloat(document.getElementById('servingSize').value);
          const totalWeight = parseFloat(document.getElementById('totalWeight').value);
          const proteinPerServing = parseFloat(document.getElementById('proteinPerServing').value);
          const fatPerServing = parseFloat(document.getElementById('fatPerServing').value);
          const carbPerServing = parseFloat(document.getElementById('carbPerServing').value);
          const wheyWeight = parseFloat(document.getElementById('wheyWeight').value);

          const errors = [];

          if (isNaN(servingSize) || servingSize <= 0) {
              errors.push("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯ä»½é‡é‡ï¼ˆå¤§äº0ï¼‰");
          }

          if (isNaN(totalWeight) || totalWeight <= 0) {
              errors.push("è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»é‡é‡ï¼ˆå¤§äº0ï¼‰");
          }

          if (isNaN(proteinPerServing) || proteinPerServing < 0) {
              errors.push("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯ä»½è›‹ç™½è´¨å«é‡ï¼ˆå¤§äºç­‰äº0ï¼‰");
          }

          if (isNaN(fatPerServing) || fatPerServing < 0) {
              errors.push("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯ä»½è„‚è‚ªå«é‡ï¼ˆå¤§äºç­‰äº0ï¼‰");
          }

          if (isNaN(carbPerServing) || carbPerServing < 0) {
              errors.push("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯ä»½ç¢³æ°´åŒ–åˆç‰©å«é‡ï¼ˆå¤§äºç­‰äº0ï¼‰");
          }

          if (isNaN(wheyWeight) || wheyWeight <= 0) {
              errors.push("è¯·è¾“å…¥æœ‰æ•ˆçš„ä¹³æ¸…é‡é‡ï¼ˆå¤§äº0ï¼‰");
          }

          if (!isNaN(totalWeight) && !isNaN(wheyWeight) && wheyWeight >= totalWeight) {
              errors.push("ä¹³æ¸…é‡é‡ä¸èƒ½å¤§äºç­‰äºæ€»é‡é‡");
          }

          return errors;
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
          const resultDisplay = document.getElementById('resultDisplay');
          resultDisplay.innerHTML = `<div class="error">âŒ è¾“å…¥é”™è¯¯<br><br>${message}</div>`;
      }

      // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      function showSuccess(message) {
          const resultDisplay = document.getElementById('resultDisplay');
          resultDisplay.innerHTML = `<div class="success">âœ… ${message}</div>`;
      }

      // è®¡ç®—è¥å…»ç´ 
      function calculateNutrients() {
          // éªŒè¯è¾“å…¥
          const errors = validateInputs();
          if (errors.length > 0) {
              showError(errors.join('<br>â€¢ '));
              return;
          }

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          const loading = document.getElementById('loading');
          const resultDisplay = document.getElementById('resultDisplay');
          loading.style.display = 'block';
          resultDisplay.innerHTML = '';

          // æ¨¡æ‹Ÿè®¡ç®—å»¶è¿Ÿï¼ˆå¢åŠ ç”¨æˆ·ä½“éªŒï¼‰
          setTimeout(() => {
              try {
                  // è·å–è¾“å…¥æ•°æ®
                  const servingSize = parseFloat(document.getElementById('servingSize').value);
                  const totalWeight = parseFloat(document.getElementById('totalWeight').value);
                  const nutrientsPerServing = {
                      protein: parseFloat(document.getElementById('proteinPerServing').value),
                      fat: parseFloat(document.getElementById('fatPerServing').value),
                      carbohydrate: parseFloat(document.getElementById('carbPerServing').value)
                  };
                  const wheyWeight = parseFloat(document.getElementById('wheyWeight').value);

                  // è®¡ç®—æ€»è¥å…»ç´ å«é‡
                  const totalNutrients = calculator.calculateTotalNutrients(servingSize, totalWeight, nutrientsPerServing);

                  const inputData = {
                      servingSize,
                      totalWeight,
                      nutrientsPerServing,
                      totalNutrients,
                      wheyWeight
                  };

                  const useRealisticModel = document.getElementById('calculationModel').value === 'realistic';

                  // æ‰§è¡Œè®¡ç®—
                  const result = calculator.calculate(inputData, useRealisticModel);
                  lastResult = { inputData, result, useRealisticModel };

                  // æ˜¾ç¤ºç»“æœ
                  displayResults(inputData, result, useRealisticModel);

              } catch (error) {
                  showError(error.message);
              } finally {
                  loading.style.display = 'none';
              }
          }, 500);
      }

      // æ˜¾ç¤ºè®¡ç®—ç»“æœ
      // æ˜¾ç¤ºè®¡ç®—ç»“æœ
function displayResults(inputData, result, useRealisticModel) {
    const resultDisplay = document.getElementById('resultDisplay');
    
    let output = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    å†·èƒé…¸å¥¶è¥å…»è®¡ç®—ç»“æœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ è¾“å…¥ä¿¡æ¯æ‘˜è¦ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ¯ä»½é‡é‡ï¼š${inputData.servingSize.toFixed(0)} g
æ€»é‡é‡ï¼š${inputData.totalWeight.toFixed(1)} g
æ€»ä»½æ•°ï¼š${inputData.totalNutrients.totalServings.toFixed(1)} ä»½
è¿‡æ»¤ä¹³æ¸…é‡é‡ï¼š${inputData.wheyWeight.toFixed(1)} g
è®¡ç®—æ¨¡å‹ï¼š${useRealisticModel ? 'ç°å®æ¨¡å‹' : 'æ¯”ä¾‹åˆ†å¸ƒæ¨¡å‹'}

ğŸ“Š æ¯ä»½è¥å…»ç´ å«é‡ï¼ˆæ¥è‡ªæ ‡ç­¾ï¼‰ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è›‹ç™½è´¨ï¼š${inputData.nutrientsPerServing.protein.toFixed(1)} g/ä»½
è„‚è‚ªï¼š${inputData.nutrientsPerServing.fat.toFixed(1)} g/ä»½
ç¢³æ°´åŒ–åˆç‰©ï¼š${inputData.nutrientsPerServing.carbohydrate.toFixed(1)} g/ä»½

ğŸ“ˆ è®¡ç®—å¾—å‡ºçš„æ€»è¥å…»ç´ å«é‡ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è›‹ç™½è´¨æ€»é‡ï¼š${inputData.totalNutrients.protein.toFixed(1)} g
è„‚è‚ªæ€»é‡ï¼š${inputData.totalNutrients.fat.toFixed(1)} g
ç¢³æ°´åŒ–åˆç‰©æ€»é‡ï¼š${inputData.totalNutrients.carbohydrate.toFixed(1)} g

ğŸ¥› å†·èƒé…¸å¥¶æœ€ç»ˆç»“æœï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å†·èƒé…¸å¥¶é‡é‡ï¼š${result.concentratedWeight.toFixed(1)} g
æµ“ç¼©å€æ•°ï¼š${result.concentrationRatio.toFixed(2)} å€

ğŸ”¬ å†·èƒé…¸å¥¶è¥å…»ç´ å«é‡ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è›‹ç™½è´¨ï¼š${result.concentratedNutrients.protein.toFixed(1)} g
è„‚è‚ªï¼š${result.concentratedNutrients.fat.toFixed(1)} g
ç¢³æ°´åŒ–åˆç‰©ï¼š${result.concentratedNutrients.carbohydrate.toFixed(1)} g

ğŸ”¥ çƒ­é‡ä¿¡æ¯ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»çƒ­é‡ï¼š${result.totalCalories.toFixed(1)} kcal
æ¯100gçƒ­é‡ï¼š${result.caloriesPer100g.toFixed(1)} kcal/100g

ğŸ“Š æ¯100gè¥å…»ç´ å«é‡ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è›‹ç™½è´¨ï¼š${(result.concentratedNutrients.protein / result.concentratedWeight * 100).toFixed(1)} g/100g
è„‚è‚ªï¼š${(result.concentratedNutrients.fat / result.concentratedWeight * 100).toFixed(1)} g/100g
ç¢³æ°´åŒ–åˆç‰©ï¼š${(result.concentratedNutrients.carbohydrate / result.concentratedWeight * 100).toFixed(1)} g/100g

ğŸ’¡ è¥å…»ç´ æµå¤±æƒ…å†µï¼ˆä»…ç°å®æ¨¡å‹ï¼‰ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`;

    if (useRealisticModel) {
        const proteinLoss = inputData.totalNutrients.protein * 0.05;
        const fatLoss = inputData.totalNutrients.fat * 0.02;
        const carbLoss = inputData.totalNutrients.carbohydrate * 0.15;
        
        output += `
è›‹ç™½è´¨æµå¤±ï¼š${proteinLoss.toFixed(1)} g (5%)
è„‚è‚ªæµå¤±ï¼š${fatLoss.toFixed(1)} g (2%)
ç¢³æ°´åŒ–åˆç‰©æµå¤±ï¼š${carbLoss.toFixed(1)} g (15%)`;
    } else {
        output += `
ä½¿ç”¨æ¯”ä¾‹åˆ†å¸ƒæ¨¡å‹ï¼Œå‡è®¾è¥å…»ç´ æ— æµå¤±`;
    }

    output += `

ğŸ“ è®¡ç®—è¯´æ˜ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. æ€»è¥å…»ç´  = æ¯ä»½è¥å…»ç´  Ã— æ€»ä»½æ•°
2. å†·èƒé…¸å¥¶é‡é‡ = æ€»é‡é‡ - ä¹³æ¸…é‡é‡
3. æµ“ç¼©å€æ•° = æ€»é‡é‡ Ã· å†·èƒé…¸å¥¶é‡é‡
4. ç°å®æ¨¡å‹è€ƒè™‘è¥å…»ç´ åœ¨è¿‡æ»¤è¿‡ç¨‹ä¸­çš„æµå¤±
5. çƒ­é‡è®¡ç®—ï¼šè›‹ç™½è´¨4kcal/gï¼Œè„‚è‚ª9kcal/gï¼Œç¢³æ°´4kcal/g

â° è®¡ç®—æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}`;

    resultDisplay.textContent = output;
}


      // å¯¼å‡ºç»“æœ
      function exportResults() {
          if (!lastResult) {
              showError('æ²¡æœ‰è®¡ç®—ç»“æœå¯ä»¥å¯¼å‡ºï¼Œè¯·å…ˆè¿›è¡Œè®¡ç®—');
              return;
          }

          const resultText = document.getElementById('resultDisplay').textContent;
          const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
          const url = window.URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `å†·èƒé…¸å¥¶è®¡ç®—ç»“æœ_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          showSuccess('è®¡ç®—ç»“æœå·²å¯¼å‡ºåˆ°æ–‡ä»¶');
      }

      // å›è½¦é”®å¿«æ·è®¡ç®—
      document.addEventListener('DOMContentLoaded', function() {
          const inputs = document.querySelectorAll('input[type="number"]');
          inputs.forEach(input => {
              input.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                      calculateNutrients();
                  }
              });
          });
          
          // è®¾ç½®ç„¦ç‚¹åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
          document.getElementById('originalWeight').focus();
      });

      // ç¤ºä¾‹æ•°æ®å¡«å……ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
      function fillExampleData() {
          document.getElementById('originalWeight').value = '500';
          document.getElementById('protein').value = '15.5';
          document.getElementById('fat').value = '8.2';
          document.getElementById('carbohydrate').value = '12.3';
          document.getElementById('wheyWeight').value = '150';
      }

      // æ·»åŠ ç¤ºä¾‹æ•°æ®æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
      // fillExampleData(); // å–æ¶ˆæ³¨é‡Šä»¥è‡ªåŠ¨å¡«å……ç¤ºä¾‹æ•°æ®
  </script>
</body>
</html>
